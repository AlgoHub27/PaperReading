H.264（AVC）和H.265（HEVC）在视频编码中通过 **率失真优化（Rate-Distortion Optimization, RDO）** 来平衡码率（Rate）与失真（Distortion）。以下是两者的率失真计算原理及差异：

---

### **1. 率失真优化基本原理**

在视频编码中，RDO的目标是选择编码参数（如预测模式、运动矢量、量化参数等），使得在给定码率约束下失真最小，或在给定失真约束下码率最小。其核心是**拉格朗日优化方法**，通过代价函数  $J$  综合码率  $R$  和失真  $D$  ：

$J=D+λ⋅R$

其中， ${λ}$  是拉格朗日乘数，用于权衡码率与失真的重要性。

---

### **2. H.264的率失真计算**

在H.264中，RDO主要在**宏块（Macroblock, 16×16像素）**级别进行：

- **失真度量**：通常使用 **平方误差和（Sum of Squared Errors, SSE）** 或 **绝对误差和（Sum of Absolute Differences, SAD）**。
    
- **码率估计**：基于熵编码（如CABAC或CAVLC）的比特数预测。
    
- **λ的确定**：  
    H.264中，λ与量化参数（QP）直接相关，经验公式为：
    
    $λ=0.85⋅2^{(QP−12)/3}$
    
    该公式将QP映射为λ值，量化越粗糙（QP越大），$λ$ 越大，码率权重更高。
    

**应用场景**：

- 帧内/帧间预测模式选择。
    
- 运动矢量搜索。
    
- 量化参数调整。
    

---

### **3. H.265的率失真计算**

H.265（HEVC）在H.264的基础上引入了更灵活的编码单元结构（如**编码树单元, CTU，最大64×64像素**），并优化了RDO流程：

- **失真度量**：仍使用SSE或SAD，但在某些实现中引入了**基于感知的度量**（如结构相似性SSIM）以提升视觉质量。
    
- **码率估计**：通过更精确的熵编码模型（如CABAC的上下文优化）进行比特数预测。
    
- **λ的调整**：  
    HEVC中，λ的计算考虑了视频的时空特性，公式更复杂：
    
    $λ=α⋅2^{(QP−12)/3}$
    
    其中， $α$  根据编码配置（如帧类型、层级结构）动态调整。
    

**新增特性对RDO的影响**：

- **更大的CTU**：允许更灵活的分割方式（如32×32、64×64），RDO需评估更多分割组合。
    
- **高级预测工具**：如Merge模式、AMVP（高级运动矢量预测），需在RDO中权衡模式选择的代价。
    
- **并行优化**：HEVC支持瓦片（Tile）和波前（Wavefront）并行，RDO需考虑编码单元间的依赖关系。
    

---

### **4. 关键差异对比**

| **特性**   | **H.264**              | **H.265**                       |
| -------- | ---------------------- | ------------------------------- |
| **编码单元** | 宏块（16×16）              | 编码树单元（CTU，最大64×64）              |
| **λ公式**  | $λ=0.85⋅2^{(QP−12)/3}$ | 动态调整，考虑时空特性 $λ=α⋅2^{(QP−12)/3}$ |
| **失真优化** | 基于SSE/SAD              | 可选SSIM等感知度量                     |
| **复杂度**  | 较低（宏块级优化）              | 较高（CTU多级分割、更多模式选择）              |

---

### **5. 实际应用中的权衡**

- **低码率场景**：HEVC通过更高效的RDO算法（如基于感知的λ调整）在相同码率下比H.264减少约50%的失真。
    
- **实时编码**：H.265的高复杂度可能导致延迟，需通过硬件加速或简化RDO策略（如快速模式决策）优化。
    
- **感知优化**：部分HEVC实现结合SSIM或VMAF（视频多方法评估融合）作为失真指标，以提升主观质量。
    

---

### **总结**

H.264和H.265的率失真计算均基于拉格朗日优化框架，通过代价函数  $J=D+λR$   权衡码率与失真。H.265通过更灵活的编码结构、动态λ调整及潜在的感知优化，显著提升了压缩效率，但也增加了计算复杂度。理解两者的RDO机制，有助于在实际编码中合理选择参数以平衡压缩性能与视觉质量。